name: è‡ªåŠ¨æž„å»º Docker é•œåƒ

on:
  push:
    branches: [ dev ]
    tags:
      - 'v*'  # ç‰ˆæœ¬å·æ ‡è®°
  pull_request:
    branches: [ dev ]
  workflow_dispatch:

# æƒé™é…ç½®ï¼šä»…æŽˆäºˆGHCRæŽ¨é€å¿…éœ€çš„æœ€å°æƒé™
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    env:
      # é•œåƒåç§°
      IMAGE_NAME: web-scrcpy

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç™»å½•GHCRï¼ˆä»…æŽ¨é€åˆ°GHCRï¼Œæ— éœ€DockerHubï¼‰
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Define Repo Owner Lower
        run: |
          # åˆå§‹åŒ–æ‰€æœ‰è€…å§“å
          # æŠŠgithub.repository_ownerè½¬ä¸ºçº¯å°å†™ï¼Œé¿å…å¤§å†™å¯¼è‡´çš„é•œåƒåç§°é”™è¯¯
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_OWNER_LOWER=${REPO_OWNER_LOWER}" >> $GITHUB_ENV
      
      - name: Generate Version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·
          # å¦‚æžœæ˜¯æ ‡ç­¾æŽ¨é€ï¼Œä½¿ç”¨æ ‡ç­¾å
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${{ github.ref_name }}
          # å¦‚æžœæ˜¯åˆ†æ”¯æŽ¨é€ï¼Œä½¿ç”¨åˆ†æ”¯å-çŸ­å“ˆå¸Œ
          else
            BRANCH=${{ github.ref_name }}
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${BRANCH}-${SHORT_SHA}"
          fi
          
          echo "Generated version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Check if the Image Exists
        run: |
          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œç²¾ç®€ç‰ˆ
          IMAGE_URL="ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          
          # ä½¿ç”¨ skopeo æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆé™é»˜æ¨¡å¼ï¼Œä»…åˆ¤æ–­é€€å‡ºç ï¼‰
          if skopeo inspect --creds "user:${{ secrets.GITHUB_TOKEN }}" "docker://${IMAGE_URL}" >/dev/null 2>&1; then
            IMAGE_EXISTS="true"
          else
            IMAGE_EXISTS="false"
          fi
          
          echo "Image tag exists: $IMAGE_EXISTS"
          echo "IMAGE_EXISTS=$IMAGE_EXISTS" >> "$GITHUB_ENV"
      
      # å¦‚æžœé•œåƒå­˜åœ¨ï¼Œåœæ­¢CIè¿è¡Œ
      - name: Stop if image exists
        if: env.IMAGE_EXISTS == 'true'
        run: |
          echo "âŒ é•œåƒ ${{ env.IMAGE_NAME }}:${{ env.VERSION }} å·²å­˜åœ¨ï¼Œç»ˆæ­¢æž„å»º"
          # ä½¿ç”¨éžé›¶é€€å‡ºç ç»ˆæ­¢CI
          exit 1

      - name: Generate Tag
        run: |
          # ç”Ÿæˆæ ‡ç­¾
          # æ£€æŸ¥äº‹ä»¶ç±»åž‹å¹¶ç”Ÿæˆç›¸åº”çš„æ ‡ç­¾
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            # å¯¹äºŽåˆå¹¶çš„PRäº‹ä»¶ï¼Œä½¿ç”¨ç‰ˆæœ¬å·+PRç¼–å·
            PR_NUMBER=${{ github.event.pull_request.number }}
            FINAL_TAG="${{ env.VERSION }}-pr$PR_NUMBER"
          else
            # é»˜è®¤æƒ…å†µï¼ˆå¦‚æ‰‹åŠ¨è§¦å‘ã€å®šæ—¶ä»»åŠ¡ç­‰ï¼‰ï¼Œä½¿ç”¨ç”Ÿæˆçš„ç‰ˆæœ¬å·
            FINAL_TAG="${{ env.VERSION }}"
          fi
          
          echo "Generated tag: $FINAL_TAG"
          echo "FINAL_TAG=$FINAL_TAG" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          # æž„å»ºé•œåƒï¼ˆä¸´æ—¶æ ‡ç­¾web-scrcpy:latestï¼‰
          docker build . \
            -t web-scrcpy:latest

      - name: Tag Image
        run: |
          # è®¾ç½®é•œåƒæ ‡ç­¾
          docker tag web-scrcpy:latest ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}
          
          # éžPRäº‹ä»¶æŽ¨é€latestæ ‡ç­¾
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            docker tag web-scrcpy:latest ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:latest
          fi
          
          # è¾“å‡ºé•œåƒä¿¡æ¯
          docker images | grep ${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}

      - name: Push Image
        run: |
          # æŽ¨é€é•œåƒ
          docker push ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}
          
          # éžPRäº‹ä»¶æŽ¨é€latestæ ‡ç­¾
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            docker push ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:latest
          fi

      # ç™»å‡ºGHCR
      - name: Logout from GHCR
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œç™»å‡º
        run: docker logout ghcr.io

      - name: Build Summary
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¾“å‡ºæ‘˜è¦
        run: |
          # æ·»åŠ GitHub Actions UIä½œä¸šæ‘˜è¦
          echo "## Dockeré•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€
          if [ "${{ env.IMAGE_EXISTS }}" = "true" ]; then
            echo "âŒ **æž„å»ºçŠ¶æ€**: å·²ç»ˆæ­¢" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **ç»ˆæ­¢åŽŸå› **: é•œåƒå·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "- é•œåƒåœ°å€: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®¹å™¨ä¿¡æ¯
          echo "### ðŸ³ å®¹å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ env.FINAL_TAG }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "- **æœ€æ–°æ ‡ç­¾**: latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **å®Œæ•´é•œåƒè·¯å¾„**: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŽ¨é€çŠ¶æ€
          echo "### ðŸ“¤ æŽ¨é€çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ] && [ "${{ env.IMAGE_EXISTS }}" != "true" ]; then
            echo "âœ… é•œåƒå·²æˆåŠŸæŽ¨é€åˆ°GHCR" >> $GITHUB_STEP_SUMMARY
            echo "- ç‰ˆæœ¬æ ‡ç­¾: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "- æœ€æ–°æ ‡ç­¾: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ é•œåƒæŽ¨é€å¤±è´¥æˆ–è¢«è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºè¯¦æƒ…
          echo "### ðŸ”§ æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
