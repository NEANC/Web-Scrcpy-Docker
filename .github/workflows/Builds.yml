name: æž„å»º Docker é•œåƒå¹¶å‘å¸ƒ

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # ç‰ˆæœ¬å·æ ‡è®°
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# æƒé™é…ç½®ï¼šä»…æŽˆäºˆGHCRæŽ¨é€å¿…éœ€çš„æœ€å°æƒé™
permissions:
  contents: read
  packages: write

jobs:
  # å‡†å¤‡æ­¥éª¤ï¼Œç”¨äºŽä»£ç æ£€å‡ºã€ç‰ˆæœ¬æŽ§åˆ¶å’Œç‰ˆæœ¬å·æ›´æ–°
  meta:
    name: Gather Meta Information
    runs-on: ubuntu-24.04
    outputs:
      repo_owner_lower: ${{ steps.set_repo_owner.outputs.repo_owner_lower }}
      version: ${{ steps.set_version.outputs.version }}
      final_tag: ${{ steps.set_final_tag.outputs.final_tag }}
      should_push_latest: ${{ steps.check_latest.outputs.should_push_latest }}
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®šä¹‰ä»“åº“æ‰€æœ‰è€…åç§°ï¼ˆè½¬ä¸ºå°å†™ï¼‰
      - name: Define Repo Owner Lower
        id: set_repo_owner
        run: |
          # åˆå§‹åŒ–æ‰€æœ‰è€…å§“å
          # æŠŠgithub.repository_ownerè½¬ä¸ºçº¯å°å†™ï¼Œé¿å…å¤§å†™å¯¼è‡´çš„é•œåƒåç§°é”™è¯¯
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=${REPO_OWNER_LOWER}" | tee -a $GITHUB_OUTPUT
      
      # ç”Ÿæˆç‰ˆæœ¬å·
      - name: Generate Version
        id: set_version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·
          # å¦‚æžœæ˜¯æ ‡ç­¾æŽ¨é€ï¼Œä½¿ç”¨æ ‡ç­¾å
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${{ github.ref_name }}
          # å¦‚æžœæ˜¯åˆ†æ”¯æŽ¨é€ï¼Œä½¿ç”¨åˆ†æ”¯å-çŸ­å“ˆå¸Œ
          else
            BRANCH=${{ github.ref_name }}
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${BRANCH}-${SHORT_SHA}"
          fi
          
          echo "Generated version: $VERSION"
          echo "version=$VERSION" | tee -a $GITHUB_OUTPUT
      
      # ç”Ÿæˆæœ€ç»ˆæ ‡ç­¾
      - name: Generate Final Tag
        id: set_final_tag
        run: |
          # ç”Ÿæˆæ ‡ç­¾
          # æ£€æŸ¥äº‹ä»¶ç±»åž‹å¹¶ç”Ÿæˆç›¸åº”çš„æ ‡ç­¾
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            # å¯¹äºŽåˆå¹¶çš„PRäº‹ä»¶ï¼Œä½¿ç”¨ç‰ˆæœ¬å·+PRç¼–å·
            PR_NUMBER=${{ github.event.pull_request.number }}
            FINAL_TAG="${{ steps.set_version.outputs.version }}-pr$PR_NUMBER"
          else
            # é»˜è®¤æƒ…å†µï¼ˆå¦‚æ‰‹åŠ¨è§¦å‘ã€å®šæ—¶ä»»åŠ¡ç­‰ï¼‰ï¼Œä½¿ç”¨ç”Ÿæˆçš„ç‰ˆæœ¬å·
            FINAL_TAG="${{ steps.set_version.outputs.version }}"
          fi
          
          echo "Generated tag: $FINAL_TAG"
          echo "final_tag=$FINAL_TAG" | tee -a $GITHUB_OUTPUT
      
      # æ£€æŸ¥æ˜¯å¦åº”è¯¥æŽ¨é€latestæ ‡ç­¾
      - name: Check if should push latest tag
        id: check_latest
        run: |
          # ä»…ç‰ˆæœ¬æ ‡ç­¾ï¼ˆv*ï¼‰æŽ¨é€latestæ ‡ç­¾
          if [ "${{ github.event_name }}" != "pull_request" ] && [ "${{ github.ref_type }}" == "tag" ] && [[ "${{ github.ref_name }}" == v* ]]; then
            echo "should_push_latest=true" | tee -a $GITHUB_OUTPUT
          else
            echo "should_push_latest=false" | tee -a $GITHUB_OUTPUT
          fi

  # æž„å»ºé•œåƒï¼ˆå¤šæž¶æž„å¹¶è¡Œæž„å»ºï¼‰
  build:
    name: Build Docker Image
    needs: meta
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºå¹¶æŽ¨é€é•œåƒï¼ˆæŒ‰æž¶æž„ï¼‰
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-${{ matrix.arch }}
          cache-from: type=local,src=/tmp/.buildx-cache-${{ matrix.arch }}
          cache-to: type=local,dest=/tmp/.buildx-cache-${{ matrix.arch }},mode=max

  # æŽ¨é€é•œåƒï¼ˆåˆå¹¶æž¶æž„å¹¶æŽ¨é€ï¼‰
  push:
    name: Push Docker Image
    needs: [meta, build]
    runs-on: ubuntu-24.04
    steps:
      # ç™»å½•GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æŽ¨é€é•œåƒ
      - name: Push Docker image
        run: |
          # å°è¯•åˆ é™¤çŽ°æœ‰çš„ manifestï¼Œé¿å…å†²çª
          docker manifest rm ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }} 2>/dev/null || true
          
          # ç›´æŽ¥ä½¿ç”¨ docker buildx imagetools create æ¥åˆ›å»ºå’ŒæŽ¨é€å¤šæž¶æž„é•œåƒ
          # è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨å¤„ç†å•ä¸ªæž¶æž„é•œåƒçš„å¼•ç”¨ï¼Œé¿å… manifest list å†²çª
          docker buildx imagetools create \
            --tag ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }} \
            ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-amd64 \
            ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-arm64

          # åªæœ‰å½“ should_push_latest ä¸º true æ—¶ï¼Œæ‰åˆ›å»ºå¹¶æŽ¨é€ latest æ ‡ç­¾
          if [ "${{ needs.meta.outputs.should_push_latest }}" = "true" ]; then
            # å°è¯•åˆ é™¤çŽ°æœ‰çš„ latest manifestï¼Œé¿å…å†²çª
            docker manifest rm ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:latest 2>/dev/null || true
            
            # ä½¿ç”¨ docker buildx imagetools create æ¥åˆ›å»ºå’ŒæŽ¨é€ latest æ ‡ç­¾
            docker buildx imagetools create \
              --tag ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:latest \
              ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-amd64 \
              ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-arm64
          fi

      # ç™»å‡ºGHCR
      - name: Logout from GHCR
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œç™»å‡º
        run: docker logout ghcr.io

      # æž„å»ºæ‘˜è¦
      - name: Build Summary
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¾“å‡ºæ‘˜è¦
        run: |
          # æ·»åŠ GitHub Actions UIä½œä¸šæ‘˜è¦
          echo "## Dockeré•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®¹å™¨ä¿¡æ¯
          echo "### ðŸ³ å®¹å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ needs.meta.outputs.final_tag }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.meta.outputs.should_push_latest }}" = "true" ]; then
            echo "- **æœ€æ–°æ ‡ç­¾**: latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **å®Œæ•´é•œåƒè·¯å¾„**: ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ”¯æŒæž¶æž„**: amd64, arm64" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŽ¨é€çŠ¶æ€
          echo "### ðŸ“¤ æŽ¨é€çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… é•œåƒå·²æˆåŠŸæŽ¨é€åˆ°GHCR" >> $GITHUB_STEP_SUMMARY
            echo "- ç‰ˆæœ¬æ ‡ç­¾: ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.meta.outputs.should_push_latest }}" = "true" ]; then
              echo "- æœ€æ–°æ ‡ç­¾: ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:latest" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ é•œåƒæŽ¨é€å¤±è´¥æˆ–è¢«è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–é•œåƒå¤§å°
          echo "### ðŸ“Š é•œåƒå¤§å°" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            # å°è¯•æ‹‰å–é•œåƒå¹¶èŽ·å–å¤§å°
            if docker pull ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-amd64; then
              AMD64_SIZE=$(docker inspect --format='{{.Size}}' ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-amd64 2>/dev/null || echo "æœªçŸ¥")
              if [ "$AMD64_SIZE" != "æœªçŸ¥" ]; then
                AMD64_SIZE_HUMAN=$(echo "scale=2; $AMD64_SIZE / 1024 / 1024" | bc)MB
              else
                AMD64_SIZE_HUMAN="æœªçŸ¥"
              fi
            else
              AMD64_SIZE_HUMAN="æœªçŸ¥"
            fi
            
            if docker pull ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-arm64; then
              ARM64_SIZE=$(docker inspect --format='{{.Size}}' ghcr.io/${{ needs.meta.outputs.repo_owner_lower }}/web-scrcpy:${{ needs.meta.outputs.final_tag }}-arm64 2>/dev/null || echo "æœªçŸ¥")
              if [ "$ARM64_SIZE" != "æœªçŸ¥" ]; then
                ARM64_SIZE_HUMAN=$(echo "scale=2; $ARM64_SIZE / 1024 / 1024" | bc)MB
              else
                ARM64_SIZE_HUMAN="æœªçŸ¥"
              fi
            else
              ARM64_SIZE_HUMAN="æœªçŸ¥"
            fi
            
            echo "- **amd64 æž¶æž„**: $AMD64_SIZE_HUMAN" >> $GITHUB_STEP_SUMMARY
            echo "- **arm64 æž¶æž„**: $ARM64_SIZE_HUMAN" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **é•œåƒå¤§å°**: æž„å»ºå¤±è´¥ï¼Œæ— æ³•èŽ·å–" >> $GITHUB_STEP_SUMMARY
          fi

          # æž„å»ºè¯¦æƒ…
          echo "### ðŸ”§ æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
